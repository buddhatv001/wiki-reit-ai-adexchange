# ============================================================================
# WIKI REIT AI AD EXCHANGE - Complete Open Source Ad Tech Stack
# Smart Money Media AI / Buddha Digital Temple
# 508(c)(1)(A) Religious Organization
# ============================================================================
# 
# DEPLOYMENT: docker-compose up -d
# REQUIREMENTS: Docker + Docker Compose installed on your server
# ESTIMATED COST: $50-200/mo on AWS/DigitalOcean
# ============================================================================

version: '3.8'

services:

  # ==========================================================================
  # 1. PREBID SERVER - Server-Side Header Bidding Auction Engine
  #    Open Source: Apache 2.0 License
  #    Source: github.com/prebid/prebid-server
  # ==========================================================================
  prebid-server:
    image: prebid/prebid-server:latest
    container_name: wiki-reit-prebid-server
    ports:
      - "8000:8000"
      - "6060:6060"
    volumes:
      - ./config/prebid-server/pbs.yaml:/etc/config/pbs.yaml
      - ./config/prebid-server/stored-requests:/etc/stored-requests
    environment:
      - PBS_HOST=0.0.0.0
      - PBS_PORT=8000
      - PBS_ADMIN_PORT=6060
      - PBS_LOGLEVEL=info
    restart: always
    networks:
      - adtech-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # 2. PREBID CACHE - Stores VAST video ads and bid responses
  #    Open Source: Apache 2.0 License
  # ==========================================================================
  prebid-cache:
    image: prebid/prebid-cache:latest
    container_name: wiki-reit-prebid-cache
    ports:
      - "2424:2424"
    depends_on:
      - redis
    environment:
      - CACHE_BACKEND=redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # 3. RTB4FREE - Open Source DSP (Demand Side Platform)
  #    Includes: RTB Bidder + Campaign Manager + DMP Analytics
  #    Source: github.com/rtb4free
  # ==========================================================================
  
  # RTB Bidder Engine (Java, OpenRTB 2.8)
  rtb-bidder:
    image: rtb4free/bidder:latest
    container_name: wiki-reit-rtb-bidder
    ports:
      - "8080:8080"
      - "7379:7379"
    volumes:
      - ./config/rtb4free/bidder-config.json:/config/payday.json
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    restart: always
    networks:
      - adtech-network

  # Campaign Manager (React Frontend)
  campaign-manager:
    image: rtb4free/campaign-manager:latest
    container_name: wiki-reit-campaign-manager
    ports:
      - "3000:3000"
    environment:
      - BIDDER_HOST=rtb-bidder
      - BIDDER_PORT=8080
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=campaigns
      - DB_USER=smartmoney
      - DB_PASSWORD=${DB_PASSWORD:-changeme_in_production}
    depends_on:
      - rtb-bidder
      - postgres
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # 4. REVIVE AD SERVER - Open Source Ad Server
  #    Serves and tracks ad creatives
  #    Source: github.com/revive-adserver/revive-adserver
  # ==========================================================================
  revive-adserver:
    image: revive/revive-adserver:latest
    container_name: wiki-reit-ad-server
    ports:
      - "8888:80"
    volumes:
      - revive-data:/var/www/html
      - ./config/revive/local.conf.php:/var/www/html/var/local.conf.php
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=revive
      - DB_USER=smartmoney
      - DB_PASSWORD=${DB_PASSWORD:-changeme_in_production}
    depends_on:
      - mysql
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # 5. WIKI REIT AI DASHBOARD - Custom Ad Exchange Management
  #    Your proprietary control panel
  # ==========================================================================
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: wiki-reit-dashboard
    ports:
      - "4000:4000"
    environment:
      - PREBID_SERVER_URL=http://prebid-server:8000
      - RTB_BIDDER_URL=http://rtb-bidder:8080
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DB_HOST=postgres
      - DB_PORT=5432
    depends_on:
      - prebid-server
      - rtb-bidder
      - redis
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # 6. DISCORD BOT - Revenue Monitoring & Alerts
  # ==========================================================================
  discord-bot:
    build:
      context: ./discord-bot
      dockerfile: Dockerfile
    container_name: wiki-reit-discord-bot
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_CHANNEL_ID=${DISCORD_CHANNEL_ID}
      - PREBID_SERVER_URL=http://prebid-server:8000
      - RTB_BIDDER_URL=http://rtb-bidder:8080
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - prebid-server
      - rtb-bidder
      - redis
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # 7. NGINX REVERSE PROXY - Routes traffic, SSL termination
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: wiki-reit-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./config/nginx/ssl:/etc/nginx/ssl
    depends_on:
      - prebid-server
      - dashboard
      - revive-adserver
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # DATABASES & INFRASTRUCTURE
  # ==========================================================================
  
  redis:
    image: redis:7-alpine
    container_name: wiki-reit-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: always
    networks:
      - adtech-network
    command: redis-server --appendonly yes

  postgres:
    image: postgres:16-alpine
    container_name: wiki-reit-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=campaigns
      - POSTGRES_USER=smartmoney
      - POSTGRES_PASSWORD=${DB_PASSWORD:-changeme_in_production}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always
    networks:
      - adtech-network

  mysql:
    image: mysql:8
    container_name: wiki-reit-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_DATABASE=revive
      - MYSQL_USER=smartmoney
      - MYSQL_PASSWORD=${DB_PASSWORD:-changeme_in_production}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-changeme_root}
    volumes:
      - mysql-data:/var/lib/mysql
    restart: always
    networks:
      - adtech-network

  # ==========================================================================
  # ELK STACK - Analytics & Data Management Platform (DMP)
  # ==========================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: wiki-reit-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    restart: always
    networks:
      - adtech-network

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.0
    container_name: wiki-reit-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    restart: always
    networks:
      - adtech-network

# ==========================================================================
# VOLUMES & NETWORKS
# ==========================================================================
volumes:
  redis-data:
  postgres-data:
  mysql-data:
  es-data:
  revive-data:

networks:
  adtech-network:
    driver: bridge
    name: wiki-reit-adtech
